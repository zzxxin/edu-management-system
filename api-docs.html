<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教务管理系统 API 文档</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui.css" />
    <style>
        html {
            box-sizing: border-box;
            overflow: -moz-scrollbars-vertical;
            overflow-y: scroll;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        body {
            margin: 0;
            background: #fafafa;
        }
        .topbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-standalone-preset.js"></script>
    <script>
        window.onload = function() {
            // 内联 Swagger JSON 配置
            const swaggerSpec = {
                "openapi": "3.0.3",
                "info": {
                    "title": "教务管理系统 API 文档",
                    "description": "教务管理系统 API 文档\n\n本系统主要提供 Web 界面，API 端点主要用于第三方服务集成（如 Omise Webhook）。\n\n## 认证说明\n\n本系统使用 Laravel Session 认证，Web 界面通过 Blade 模板提供。\nAPI 端点主要用于 Webhook 回调，使用签名验证确保安全性。",
                    "version": "1.0.0",
                    "contact": {
                        "name": "API Support",
                        "email": "support@example.com"
                    },
                    "license": {
                        "name": "MIT"
                    }
                },
                "servers": [
                    {
                        "url": "https://your-domain.com/api",
                        "description": "生产环境"
                    },
                    {
                        "url": "http://localhost:8000/api",
                        "description": "本地开发环境"
                    }
                ],
                "tags": [
                    {
                        "name": "Webhook",
                        "description": "Omise 支付 Webhook 回调"
                    }
                ],
                "paths": {
                    "/omise/webhook": {
                        "post": {
                            "tags": ["Webhook"],
                            "summary": "Omise Webhook 回调",
                            "description": "处理 Omise 支付平台的 Webhook 事件。\n\n## 功能说明\n\n- 接收 Omise 发送的支付事件（charge.create, charge.complete）\n- 验证请求签名确保安全性\n- 自动更新账单和支付记录状态\n- 支持幂等性处理（可重复调用）\n\n## 安全说明\n\n- 请求必须包含 `X-Omise-Signature` 请求头\n- 签名使用 HMAC-SHA256 算法\n- 签名验证失败将返回 401 错误\n\n## 事件类型\n\n- `charge.create` - 支付创建事件\n- `charge.complete` - 支付完成事件\n\n## 幂等性保证\n\n- 使用 `omise_charge_id` 作为唯一标识\n- 重复事件不会导致数据重复更新\n- 使用数据库事务和行锁确保数据一致性",
                            "operationId": "handleOmiseWebhook",
                            "parameters": [
                                {
                                    "name": "X-Omise-Signature",
                                    "in": "header",
                                    "required": true,
                                    "description": "Omise Webhook 签名，用于验证请求的合法性。\n\n签名计算方式：`HMAC-SHA256(payload, secret_key)`\n\n其中 `payload` 为请求体的原始 JSON 字符串，`secret_key` 为 Omise Secret Key。",
                                    "schema": {
                                        "type": "string",
                                        "example": "a1b2c3d4e5f6..."
                                    },
                                    "style": "simple"
                                }
                            ],
                            "requestBody": {
                                "required": true,
                                "description": "Omise Webhook 事件数据",
                                "content": {
                                    "application/json": {
                                        "schema": {
                                            "$ref": "#/components/schemas/OmiseWebhookEvent"
                                        },
                                        "examples": {
                                            "charge_create": {
                                                "summary": "支付创建事件",
                                                "value": {
                                                    "key": "charge.create",
                                                    "data": {
                                                        "id": "chrg_test_1234567890",
                                                        "status": "pending",
                                                        "currency": "JPY",
                                                        "amount": 1000,
                                                        "metadata": {
                                                            "invoice_id": "1",
                                                            "course_id": "1",
                                                            "student_id": "1",
                                                            "year_month": "202601"
                                                        },
                                                        "source": {
                                                            "type": "card"
                                                        }
                                                    }
                                                }
                                            },
                                            "charge_complete_success": {
                                                "summary": "支付成功事件",
                                                "value": {
                                                    "key": "charge.complete",
                                                    "data": {
                                                        "id": "chrg_test_1234567890",
                                                        "status": "successful",
                                                        "currency": "JPY",
                                                        "amount": 1000,
                                                        "paid_at": "2026-01-11T16:35:32Z",
                                                        "metadata": {
                                                            "invoice_id": "1",
                                                            "course_id": "1",
                                                            "student_id": "1",
                                                            "year_month": "202601"
                                                        },
                                                        "source": {
                                                            "type": "card"
                                                        }
                                                    }
                                                }
                                            },
                                            "charge_complete_failed": {
                                                "summary": "支付失败事件",
                                                "value": {
                                                    "key": "charge.complete",
                                                    "data": {
                                                        "id": "chrg_test_1234567890",
                                                        "status": "failed",
                                                        "currency": "JPY",
                                                        "amount": 1000,
                                                        "failure_message": "Card declined",
                                                        "metadata": {
                                                            "invoice_id": "1",
                                                            "course_id": "1",
                                                            "student_id": "1",
                                                            "year_month": "202601"
                                                        },
                                                        "source": {
                                                            "type": "card"
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "responses": {
                                "200": {
                                    "description": "处理成功或忽略的事件",
                                    "content": {
                                        "application/json": {
                                            "schema": {
                                                "type": "object",
                                                "properties": {
                                                    "status": {
                                                        "type": "string",
                                                        "enum": ["success", "ignored"],
                                                        "description": "处理状态。success 表示成功处理，ignored 表示忽略（非相关事件）",
                                                        "example": "success"
                                                    }
                                                }
                                            },
                                            "examples": {
                                                "success": {
                                                    "summary": "成功处理",
                                                    "value": {
                                                        "status": "success"
                                                    }
                                                },
                                                "ignored": {
                                                    "summary": "忽略的事件",
                                                    "value": {
                                                        "status": "ignored"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                },
                                "401": {
                                    "description": "签名验证失败",
                                    "content": {
                                        "application/json": {
                                            "schema": {
                                                "$ref": "#/components/schemas/ErrorResponse"
                                            },
                                            "examples": {
                                                "missing_signature": {
                                                    "summary": "缺少签名",
                                                    "value": {
                                                        "error": "Missing signature"
                                                    }
                                                },
                                                "invalid_signature": {
                                                    "summary": "无效签名",
                                                    "value": {
                                                        "error": "Invalid signature"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                },
                                "500": {
                                    "description": "服务器内部错误",
                                    "content": {
                                        "application/json": {
                                            "schema": {
                                                "$ref": "#/components/schemas/ErrorResponse"
                                            },
                                            "example": {
                                                "error": "Processing failed"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                "components": {
                    "schemas": {
                        "OmiseWebhookEvent": {
                            "type": "object",
                            "required": ["key", "data"],
                            "properties": {
                                "key": {
                                    "type": "string",
                                    "description": "事件类型",
                                    "enum": ["charge.create", "charge.complete"],
                                    "example": "charge.complete"
                                },
                                "data": {
                                    "$ref": "#/components/schemas/OmiseCharge"
                                }
                            }
                        },
                        "OmiseCharge": {
                            "type": "object",
                            "required": ["id", "status"],
                            "properties": {
                                "id": {
                                    "type": "string",
                                    "description": "Omise Charge ID",
                                    "example": "chrg_test_1234567890"
                                },
                                "status": {
                                    "type": "string",
                                    "description": "支付状态",
                                    "enum": ["pending", "successful", "failed"],
                                    "example": "successful"
                                },
                                "currency": {
                                    "type": "string",
                                    "description": "货币代码（大写）",
                                    "enum": ["JPY", "THB", "SGD", "USD"],
                                    "example": "JPY"
                                },
                                "amount": {
                                    "type": "integer",
                                    "description": "支付金额（最小货币单位，JPY 为整数，其他货币为分）",
                                    "example": 1000
                                },
                                "paid_at": {
                                    "type": "string",
                                    "format": "date-time",
                                    "description": "支付完成时间（ISO 8601 格式）",
                                    "example": "2026-01-11T16:35:32Z"
                                },
                                "failure_message": {
                                    "type": "string",
                                    "nullable": true,
                                    "description": "失败原因（支付失败时）",
                                    "example": "Card declined"
                                },
                                "metadata": {
                                    "type": "object",
                                    "description": "自定义元数据",
                                    "required": ["invoice_id"],
                                    "properties": {
                                        "invoice_id": {
                                            "type": "string",
                                            "description": "账单ID",
                                            "example": "1"
                                        },
                                        "course_id": {
                                            "type": "string",
                                            "description": "课程ID",
                                            "example": "1"
                                        },
                                        "student_id": {
                                            "type": "string",
                                            "description": "学生ID",
                                            "example": "1"
                                        },
                                        "year_month": {
                                            "type": "string",
                                            "description": "年月（格式：YYYYMM）",
                                            "example": "202601"
                                        }
                                    }
                                },
                                "source": {
                                    "type": "object",
                                    "description": "支付来源信息",
                                    "properties": {
                                        "type": {
                                            "type": "string",
                                            "description": "支付方式类型",
                                            "enum": ["card", "internet_banking", "etc."],
                                            "example": "card"
                                        }
                                    }
                                }
                            }
                        },
                        "ErrorResponse": {
                            "type": "object",
                            "properties": {
                                "error": {
                                    "type": "string",
                                    "description": "错误信息",
                                    "example": "Invalid signature"
                                }
                            }
                        },
                        "SuccessResponse": {
                            "type": "object",
                            "properties": {
                                "status": {
                                    "type": "string",
                                    "enum": ["success", "ignored"],
                                    "example": "success"
                                }
                            }
                        }
                    },
                    "securitySchemes": {
                        "OmiseWebhookSignature": {
                            "type": "apiKey",
                            "in": "header",
                            "name": "X-Omise-Signature",
                            "description": "Omise Webhook 签名。\n\n签名计算方式：使用 HMAC-SHA256 算法，密钥为 Omise Secret Key。\n\n示例代码（PHP）：\n```php\n$signature = hash_hmac('sha256', $payload, $secretKey);\n```\n\n示例代码（Node.js）：\n```javascript\nconst crypto = require('crypto');\nconst signature = crypto.createHmac('sha256', secretKey).update(payload).digest('hex');\n```"
                        }
                    }
                },
                "security": [
                    {
                        "OmiseWebhookSignature": []
                    }
                ]
            };

            const ui = SwaggerUIBundle({
                spec: swaggerSpec,
                dom_id: '#swagger-ui',
                deepLinking: true,
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                ],
                plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                ],
                layout: "StandaloneLayout",
                validatorUrl: null,
                docExpansion: "list",
                filter: true,
                showExtensions: true,
                showCommonExtensions: true,
                tryItOutEnabled: true
            });
        };
    </script>
</body>
</html>
